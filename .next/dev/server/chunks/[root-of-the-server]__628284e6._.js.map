{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///D:/MEUS%20PROJETOS/my-landing/pages/api/payment-webhook.js"],"sourcesContent":["// pages/api/payment-webhook.js\nexport default async function handler(req, res) {\n  if (req.method !== \"POST\") {\n    return res.status(405).json({ error: \"Use POST\" });\n  }\n\n  // logs de depuração (seguros)\n  console.log(\n    \"DBG: GOOGLE_CLIENT_EMAIL defined:\",\n    !!process.env.GOOGLE_CLIENT_EMAIL\n  );\n  console.log(\n    \"DBG: GOOGLE_PRIVATE_KEY defined:\",\n    !!process.env.GOOGLE_PRIVATE_KEY\n  );\n  console.log(\n    \"DBG: GOOGLE_PRIVATE_KEY length:\",\n    process.env.GOOGLE_PRIVATE_KEY\n      ? process.env.GOOGLE_PRIVATE_KEY.length\n      : \"undefined\"\n  );\n  console.log(\n    \"DBG: GOOGLE_APPLICATION_CREDENTIALS:\",\n    process.env.GOOGLE_APPLICATION_CREDENTIALS || \"undefined\"\n  );\n  console.log(\"DBG: DRIVE_FILE_ID defined:\", !!process.env.DRIVE_FILE_ID);\n\n  try {\n    // imports dinâmicos para evitar bundling em produção\n    const { google } = await import(\"googleapis\");\n    const { JWT } = await import(\"google-auth-library\");\n    const mpModule = await import(\"mercadopago\");\n    const MercadoPago = mpModule.default ?? mpModule;\n\n    // inicializa Mercado Pago (compatível com diferentes versões do SDK)\n    try {\n      if (typeof MercadoPago.configure === \"function\") {\n        MercadoPago.configure({ access_token: process.env.MP_ACCESS_TOKEN });\n      } else if (MercadoPago?.configurations?.setAccessToken) {\n        MercadoPago.configurations.setAccessToken(process.env.MP_ACCESS_TOKEN);\n      } else if (typeof MercadoPago.setAccessToken === \"function\") {\n        MercadoPago.setAccessToken(process.env.MP_ACCESS_TOKEN);\n      } else {\n        console.warn(\n          \"SDK do Mercado Pago: método de configuração não encontrado. Continuando sem configurar via SDK.\"\n        );\n      }\n    } catch (mpErr) {\n      console.warn(\n        \"Falha ao configurar MercadoPago (não crítico):\",\n        mpErr?.message || mpErr\n      );\n    }\n\n    // utilitário para criar cliente Google (aceita env ou arquivo)\n    const fs = await import(\"fs\");\n\n    // DEBUG ADICIONAL: preview seguro do PEM (não imprime a chave inteira)\n    try {\n      const pkFromEnv = process.env.GOOGLE_PRIVATE_KEY;\n      const pkFromFile =\n        process.env.GOOGLE_APPLICATION_CREDENTIALS &&\n        fs.existsSync(process.env.GOOGLE_APPLICATION_CREDENTIALS)\n          ? require(process.env.GOOGLE_APPLICATION_CREDENTIALS).private_key\n          : undefined;\n      const pkRaw = pkFromEnv || pkFromFile || undefined;\n\n      if (pkRaw) {\n        const preview = pkRaw.slice(0, 160).replace(/\\n/g, \"\\\\n\");\n        console.log(\"DBG: private_key preview:\", preview);\n        console.log(\n          \"DBG: private_key contains ENCRYPTED:\",\n          preview.includes(\"ENCRYPTED\")\n        );\n        console.log(\n          \"DBG: private_key contains BEGIN RSA PRIVATE KEY:\",\n          preview.includes(\"BEGIN RSA PRIVATE KEY\")\n        );\n        console.log(\n          \"DBG: private_key contains BEGIN PRIVATE KEY:\",\n          preview.includes(\"BEGIN PRIVATE KEY\")\n        );\n        console.log(\n          \"DBG: private_key contains literal backslash-n sequences:\",\n          /\\\\n/.test(pkRaw)\n        );\n      } else {\n        console.log(\"DBG: private_key not found in env or file\");\n      }\n    } catch (previewErr) {\n      console.warn(\n        \"DBG: falha ao gerar preview da private_key:\",\n        previewErr?.message || previewErr\n      );\n    }\n\n    function createGoogleClient() {\n      // 1) usar GOOGLE_PRIVATE_KEY + GOOGLE_CLIENT_EMAIL (mais comum em env)\n      if (process.env.GOOGLE_PRIVATE_KEY && process.env.GOOGLE_CLIENT_EMAIL) {\n        const key = process.env.GOOGLE_PRIVATE_KEY.replace(/\\\\n/g, \"\\n\");\n        return new JWT({\n          email: process.env.GOOGLE_CLIENT_EMAIL,\n          key,\n          scopes: [\"https://www.googleapis.com/auth/drive\"],\n        });\n      }\n\n      // 2) usar GOOGLE_APPLICATION_CREDENTIALS apontando para JSON\n      if (\n        process.env.GOOGLE_APPLICATION_CREDENTIALS &&\n        fs.existsSync(process.env.GOOGLE_APPLICATION_CREDENTIALS)\n      ) {\n        const creds = require(process.env.GOOGLE_APPLICATION_CREDENTIALS);\n        const key = (creds.private_key || \"\").replace(/\\\\n/g, \"\\n\");\n        return new JWT({\n          email: creds.client_email,\n          key,\n          scopes: [\"https://www.googleapis.com/auth/drive\"],\n        });\n      }\n\n      // nenhum método disponível\n      throw new Error(\n        \"Nenhuma credencial encontrada: defina GOOGLE_PRIVATE_KEY/GOOGLE_CLIENT_EMAIL ou GOOGLE_APPLICATION_CREDENTIALS\"\n      );\n    }\n\n    // criar cliente e autorizar (com tratamento de erro detalhado)\n    let googleClient;\n    try {\n      googleClient = createGoogleClient();\n    } catch (createErr) {\n      console.error(\n        \"Auth create client failed:\",\n        createErr.message || createErr\n      );\n      return res.status(500).json({\n        error: \"Auth create client failed\",\n        details: createErr.message || String(createErr),\n      });\n    }\n\n    try {\n      // authorize() retorna token info; getAccessToken() também é possível\n      const tokenInfo = await googleClient.authorize();\n      console.log(\n        \"DBG: Google auth OK, token keys:\",\n        Object.keys(tokenInfo || {})\n      );\n    } catch (authErr) {\n      console.error(\n        \"Auth authorize failed:\",\n        authErr.response?.data || authErr.message || authErr\n      );\n      return res.status(500).json({\n        error: \"Auth authorize failed\",\n        details: authErr.response?.data || authErr.message || String(authErr),\n      });\n    }\n\n    const drive = google.drive({ version: \"v3\", auth: googleClient });\n\n    // lógica do webhook\n    const { status, payer } = req.body || {};\n    if (status !== \"approved\") {\n      return res.status(200).json({ message: \"Pagamento não aprovado\" });\n    }\n\n    const buyerEmail = payer?.email;\n    if (!buyerEmail) {\n      return res\n        .status(400)\n        .json({ error: \"Email do comprador não encontrado\" });\n    }\n\n    // criar permissão no Drive\n    try {\n      await drive.permissions.create({\n        fileId: process.env.DRIVE_FILE_ID,\n        requestBody: { type: \"user\", role: \"reader\", emailAddress: buyerEmail },\n        sendNotificationEmail: true,\n      });\n    } catch (driveErr) {\n      console.error(\n        \"Drive permissions.create failed:\",\n        driveErr.response?.data || driveErr.message || driveErr\n      );\n      return res.status(500).json({\n        error: \"Drive permissions failed\",\n        details:\n          driveErr.response?.data || driveErr.message || String(driveErr),\n      });\n    }\n\n    return res\n      .status(200)\n      .json({ ok: true, message: \"Acesso liberado ao PDF\" });\n  } catch (err) {\n    console.error(\"Erro no webhook:\", err);\n    return res\n      .status(500)\n      .json({ error: \"Erro interno\", details: err?.message || String(err) });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}